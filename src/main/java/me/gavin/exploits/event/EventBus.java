package me.gavin.exploits.event;

import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

public class EventBus {
    public static Map<Object, List<Method>> registered = new HashMap<>();

    public void subscribe(Object obj) {
        registered.put(obj, Arrays.stream(obj.getClass()
                .getDeclaredMethods())
                .filter(method -> method.isAnnotationPresent(EventListener.class)).collect(Collectors.toList()));
    }

    public void unsubscribe(Object obj) {
        registered.remove(obj);
    }

    public void post(CancellableEvent event) {
        registered.forEach((object, methods) -> registered.get(object).stream()
                .filter(method -> method.getParameterTypes()[0] == event.getClass())
                .forEach(method -> {
                    try {
                        method.invoke(object, event);
                    } catch (IllegalAccessException | InvocationTargetException e) {
                        e.printStackTrace();
                    }
                }));
    }
}