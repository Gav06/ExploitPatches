package me.gavin.exploits;

import me.gavin.exploits.commands.CrashCommand;
import me.gavin.exploits.commands.ReloadCommand;
import me.gavin.exploits.event.EventBus;
import me.gavin.kotlin.patch.*;
import org.bukkit.command.CommandExecutor;
import org.bukkit.configuration.file.FileConfiguration;
import org.bukkit.event.Listener;
import org.bukkit.plugin.java.JavaPlugin;

public class Main extends JavaPlugin {

    public static Main get() {
        return getPlugin(Main.class);
    }

    public FileConfiguration config = getConfig();
    public static EventBus EVENT_BUS;

    private EventProcessor processor;

    @Override
    public void onEnable() {
        this.saveDefaultConfig();

        // event
        EVENT_BUS = new EventBus();
        processor = new EventProcessor();
        Utils.log("Event processor initialized");

        // cmds
        registerCommand(new ReloadCommand(), "exreload");
        registerCommand(new CrashCommand(), "tacocrash");
        Utils.log("Commands registered");

        // patches
        registerEvent(new SkullRemover());
        registerEvent(new HopperLag());
        registerEvent(new ShulkerCrash());
        registerEvent(new RedstoneLag());

        registerEvent(new SandCrash());

        Utils.log("Patches registered");
    }

    @Override
    public void onDisable() {
        processor.timer.purge();
        processor.timer.cancel();
        Utils.log("Cancelling timer");
    }

    private void registerEvent(Object obj) { EVENT_BUS.subscribe(obj); }
    private void registerEvent(Listener listener) {
        getServer().getPluginManager().registerEvents(listener, this);
    }
    private void registerCommand(CommandExecutor executor, String cmd) {
        getCommand(cmd).setExecutor(executor);
    }
}
